substitutions:
  # _PROJECT_ID: actemo-demo
  # _IMAGE_NAME: actemo-image
  _REGION: asia-northeast1
  _SERVICE_NAME: actemo-server

steps:  
### 0. Pull the latest image
  # - id: "pull latest image"
  #   name: "gcr.io/cloud-builders/docker"
  #   entrypoint: "bash"
  #   args: ["-c", "docker pull gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest || exit 0"]

### 1. Build the Docker image
  - id: "build image"
    name: "gcr.io/cloud-builders/docker"
    args: 
      - "build"
      - "-f"
      - "./SER_model/Dockerfile.prod"
      - "-t"
      - "gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$COMMIT_SHA"
      - "--cache-from"
      - "gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest"
      - "."

### 2. Push 
  - id: "push image"
    name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$COMMIT_SHA"]

## 3. Deploy
  - id: "deploy prod service"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args: ["run", "deploy", "${_SERVICE_NAME}", "--image", "gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$COMMIT_SHA", "--port", "8080", "--region", "${_REGION}"]

images:
  - 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$COMMIT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY 

